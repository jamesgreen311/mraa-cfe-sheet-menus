<script>
  document.addEventListener('DOMContentLoaded', pageLoaded);

  function pageLoaded() {
    let evtId = document.getElementById('btnSave').dataset.id;
    let evtName = document.getElementById('btnSave').dataset.name;
    // disable artist info input until email validated
    disableArtistInfoFields();
    disableNextButton();
    disablePayFeesTab();
    disableUploadImagesTab();
    setArtistInfoPlaceholders("Will be auto filled with a valid MRAA email address");
    google.script.run.withSuccessHandler(setCopyrightYear).getCurrentYear();
    google.script.run.withSuccessHandler(setMaxEntries).getMaxEntriesPerShow(evtId);
    google.script.run.withSuccessHandler(setMaxPerArtist).getMaxEntriesPerArtist(evtId);
    google.script.run.withSuccessHandler(setEntriesSubmitted).getTotalByEvent(evtName);
    google.script.run.withSuccessHandler(setMaxImageSize).getMaxImageSize();
    document.getElementById('emailAddress').addEventListener('change', checkMemberEmail);
    document.getElementById('imageFile').addEventListener("change", showThumbnail);
  }

  function setArtistInfoPlaceholders(placeholder) {
    document.getElementById('firstName').placeholder = placeholder;
    document.getElementById('lastName').placeholder = placeholder;
    document.getElementById('phoneNumber').placeholder = placeholder;   
  }

  function disableArtistInfoFields() {
    document.getElementById('firstName').disabled = true;
    document.getElementById('lastName').disabled = true;
    document.getElementById('phoneNumber').disabled = true;
  }

  function disableNextButton() {
    document.getElementById('btnNextUpload').disabled = true;
  }

  function disablePayFeesTab() {
    document.getElementById('pills-pay-fees-tab').disabled = true;
  }

  function enablePayFeesTab() {
    document.getElementById('pills-pay-fees-tab').disabled = false;
  }
  
  function disableUploadImagesTab() {
    document.getElementById('pills-upload-images-tab').disabled = true;
  }

  function enableUploadImagesTab() {
    document.getElementById('pills-upload-images-tab').disabled = false;
  }
  
  function enableNextButton() {
    document.getElementById('btnNextUpload').disabled = false;
  }

  function enableArtistInfoFields() {
    document.getElementById('firstName').disabled = false;
    document.getElementById('firstName').focus();
    document.getElementById('lastName').disabled = false;
    document.getElementById('phoneNumber').disabled = false;
  }

  function setCopyrightYear(yr) {
    document.getElementById("copyrightYear").innerHTML = `Copyright &copy; ${yr}`;
  }

  function setMaxEntries(max) {
    if (max===0) {
      document.getElementById("maxEntries").innerText = "Unknown";
    } else {
      document.getElementById("maxEntries").innerText = max;      
    }
  }

  function setMaxPerArtist(max) {
    if (max === 0) {
      document.getElementById("maxPerArtist").innerText = "Unknown";
    } else {
      document.getElementById("maxPerArtist").innerText = max;
    }
  }

  function setEntriesSubmitted(count) {
    document.getElementById("entriesSubmitted").innerText = count;
  }

  function setMaxImageSize(size) {
    document.getElementById("maxImageSize").innerText = size
  }
  
  function showMemberFirstName(name) {
    document.getElementById("firstName").value = name;
  }

  function showMemberLastName(name) {
    document.getElementById("lastName").value = name;
  }

  function showMemberPhone(phoneNumber) {
    document.getElementById("phoneNumber").value = phoneNumber;
  }

  function setUploadHistory(list) {
    let historyEl = document.getElementById("upload-history-list")
    let historyContainer = document.getElementById("upload-history")

    historyContainer.style.display = "block"

    if (list.length<=0) {
      historyEl.innerText = "No images have been uploaded for this event"
    } else {
      a = list.split(',')
      for (let l = 0; l<a.length; l++) {
        item = a[l]
        historyEl.innerHTML += (l+1) + ". " + item + "<br>"
      }
    }
  }

  function showMemberSuccess(good) {
    if (good) {
      let el = document.getElementById('memberStatus')
      el.innerText = "Welcome Exhibiting MRAA Member";
      el.classList.remove("badge-danger");
      el.classList.add("badge-success");
      enableArtistInfoFields();
      enableNextButton();
      enablePayFeesTab()
      enableUploadImagesTab();    
  } else {
      let el = document.getElementById('memberStatus')
      el.innerHTML = "Not a recognized Exhibiting MRAA Member Email Address. <br><br>If your email address has changed, please contact MRAA.";
      el.classList.remove("badge-success");
      el.classList.add("badge-danger");
      setArtistInfoPlaceholders("Please enter your MRAA registered email address");
    }
  }

  function checkMemberEmail(el) {
    let email = this.value;
    let evtName = document.getElementById('btnSave').dataset.name;

    document.getElementById('upload-history-list').innerText = ""

    setArtistInfoPlaceholders("Retrieving ...");
    google.script.run.withSuccessHandler(showMemberSuccess).isMember(email.toLowerCase());
    google.script.run.withSuccessHandler(showMemberFirstName).getMemberFirstName(email);
    google.script.run.withSuccessHandler(showMemberLastName).getMemberLastName(email);
    google.script.run.withSuccessHandler(showMemberPhone).getMemberPhone(email);
    google.script.run.withSuccessHandler(setSubmitsByArtist).getTotalByEventArtist(evtName, email)
    google.script.run.withSuccessHandler(setUploadHistory).getUploadsByArtist(evtName, email)
  }
</script>